name: CI/CD Pipeline

on:
  push:
    branches: ["main"]    
  pull_request:
    branches: ["main"]

jobs:
  test:
    name: ðŸ” Run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: |
          echo "run tests here"
          # npm install && npm test  (××• ×ž×” ×©×ž×ª××™× ×œ×š)

  build_and_push:
    name: ðŸ› ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/myapp:latest .
      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/myapp:latest

  deploy:
    name: ðŸš€ Deploy to Kubernetes (dev namespace)
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - uses: actions/checkout@v3
      - name: Set up kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
      - name: Deploy to Kubernetes (dev namespace)
        run: |
          find DEPLOY -name "*.yaml" -print0 | xargs -0 kubectl apply -n dev -f
        shell: bash
